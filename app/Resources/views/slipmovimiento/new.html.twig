{% extends 'estructura/plantilla.twig' %}

{% block contwrapper %}
    <div class="content-wrapper">
        <section class="content">
            <div class="panel panel-novo">
                <div class="panel-heading">
                    <div class="row">
                        <div class="col-sm-6">
                            <h3 class="panel-title">Asignar Slip</h3>
                        </div>
                        <div class="col-sm-6">
                            <a href="{{ path('slipmovimiento_index') }}" class="btn btn-contorno-azul pull-right">
                                Regresar
                            </a>
                        </div>
                    </div>
                </div>
                <div class="panel-body">
                    {% for message in app.flashes('notice') %}
                        <div class="row">
                            <div class="col-sm-6">
                                <div class="alert alert-danger alert-dismissible">
                                    <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×
                                    </button>
                                    <span class="glyphicon glyphicon-exclamation-sign"></span> {{ message }}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                    {{ form_start(form) }}
                    <div class="row">
                        <div class="col-sm-6">
                            {{ form_widget(form) }}
                        </div>
                        <div class="col-sm-6">
                            <table class="table">
                                <thead>
                                <tr>
                                    <th colspan="2" class="text-center">Estadía del Barco</th>
                                </tr>
                                <tr>
                                    <th>Fecha Llegada</th>
                                    <th>Fecha Salida</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <td class="c_llegada"></td>
                                    <td class="c_salida"></td>
                                </tr>
                                </tbody>
                            </table>

                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6">
                            <div class="disponibilidad">
                            </div>
                            <div class="tabla-ocupado">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6">
                            <button type="submit" class="btn btn-azul">
                                <i class="fa fa-floppy-o" aria-hidden="true"></i>
                                Guardar
                            </button>
                        </div>
                    </div>
                    {{ form_end(form) }}
                </div>
            </div>
        </section>
    </div>
{% endblock %}
{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript">
      $('#appbundle_slipmovimiento_marinahumedacotizacion').on('change', function () {
        $('#loading').show();
        var eslora = $(this).find(':selected').data('eslora');
        var llegada = $(this).find(':selected').data('llegada');
        var salida = $(this).find(':selected').data('salida');


        $('.c_llegada').html(llegada);
        $('.c_salida').html(salida);

        var url = "{{ path('ajax_buscar_slips',{'eslora':'numeslora','id':1,'_format':'json'}) }}";
        url = url.replace("numeslora", eslora);

        //limpiando divs
        /*$("#appbundle_slipmovimiento_slip>option").each(function () {
          $(this).attr("style", "display:none");
        });*/

        $("#appbundle_slipmovimiento_slip").val('');
        $('.disponibilidad').html('');
        $('.tabla-ocupado').html('');

        $.ajax({
          method: "GET",
          url: url,
          dataType: 'json',
          success: function (slips) {
            $("#appbundle_slipmovimiento_slip > option").each(function () {
              for (var k in slips) {
                if ($(this).val() == slips[k].id) {
                  // $(this).attr("style", "display:block");
                  $(this).data("llegada", llegada);
                  $(this).data("salida", salida);
                }
              }
            });
            $('#loading').hide();
          }
        }).always(function () {
          $('#loading').hide();
        });
      });

      $('#appbundle_slipmovimiento_slip').on('change', function () {
        $('.tabla-ocupado').html('');

        var cotizacionSelectedOption = $('#appbundle_slipmovimiento_marinahumedacotizacion');

        // var slip = $(this).find(':selected').val();
        // var eslora = $(this).find(':selected').data('eslora');
        // var llegada = $(this).find(':selected').data('llegada');
        // var salida = $(this).find(':selected').data('salida');
        var slip = $(this).val();
        console.log($(this).val());
        var eslora = cotizacionSelectedOption.find(':selected').data('eslora');
        var llegada = cotizacionSelectedOption.find(':selected').data('llegada');
        var salida = cotizacionSelectedOption.find(':selected').data('salida');

        var url = "{{ path('ajax_buscar__movimientos_slip',{'slip':'numslip','llegada':'lallegada','salida':'lasalida','id':4,'_format':'json'}) }}";
        url = url.replace("numslip", slip);
        url = url.replace("lallegada", llegada);
        url = url.replace("lasalida", salida);
        $('.disponibilidad').html('');
        $.ajax({
          method: "GET",
          url: url,
          dataType: 'json',
          success: function (slipMovimietos) {
            if (slipMovimietos == "") {
              $('.disponibilidad').html('<div class="alert alert-success" role="alert">Slip disponible</div>');
            } else {
              for (var k in slipMovimietos) {
                $('.disponibilidad').html('<div class="alert alert-danger" role="alert"><span class="glyphicon glyphicon-exclamation-sign"></span> Slip ocupado</div>');
                $('.tabla-ocupado').html('<table class="table"><thead><tr><th>Fecha Llegada</th><th>Fecha Salida</th></tr></thead>' +
                    '<tbody><tr><td>' + slipMovimietos[k].fechaLlegada + '</td>' +
                    '<td>' + slipMovimietos[k].fechaSalida + '</td></tr></tbody></table>')
              }
            }
            $('#loading').hide();
          }
        }).always(function () {
          $('#loading').hide();
        });
      });
    </script>
{% endblock %}
