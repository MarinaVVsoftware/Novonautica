{% extends 'estructura/plantilla.twig' %}
{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet"
          href="{{ asset('css/jsgantt.css') }}">
{% endblock %}
{% block contwrapper %}
    <div class="content-wrapper">
        <section class="content">
            <div class="panel panel-novo">
                <div class="panel-heading">
                    <div class="row">
                        <div class="col-sm-6">
                            <h3 class="panel-title">{{ title }}</h3>
                            <span>
                                 {% if ordenDeTrabajo.astilleroCotizacion.foliorecotiza == 0 %}
                                     {{ ordenDeTrabajo.astilleroCotizacion.folio }}
                                 {% else %}
                                     {{ ordenDeTrabajo.astilleroCotizacion.folio }}-{{ ordenDeTrabajo.astilleroCotizacion.foliorecotiza }}
                                 {% endif %}
                            </span>
                        </div>
                        <div class="col-sm-6">
                            <a class="btn btn-contorno-azul pull-right"
                               href="{{ path('ordendetrabajo_index') }}">Regresar</a>
                        </div>
                    </div>
                </div>
                <div class="panel-body panel-pestanias">
                    <ul class="nav nav-tabs" role="tablist">
                        <li role="presentation" class="primero active">
                            <a href="#generales" aria-controls="generales" role="tab" data-toggle="tab">Generales</a>
                        </li>
                        <li role="presentation">
                            <a href="#contratistas" aria-controls="contratistas" role="tab" data-toggle="tab">Contratistas</a>
                        </li>
                        <li class="flujograma" role="presentation">
                            <a href="#flujograma" aria-controls="flujograma" role="tab" data-toggle="tab">Flujograma</a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div role="tabpanel" class="tab-pane active" id="generales">
                            <div class="row">
                                <div class="col-sm-4">
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <div class="letra-azul">Nombre:</div>
                                            <ul>{{ ordenDeTrabajo.astilleroCotizacion.cliente.nombre }}</ul>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <div class="letra-azul">Teléfono:</div>
                                            <ul>{{ ordenDeTrabajo.astilleroCotizacion.cliente.telefono }}</ul>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <div class="letra-azul">Celular:</div>
                                            <ul>{{ ordenDeTrabajo.astilleroCotizacion.cliente.celular }}</ul>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <div class="letra-azul">Correo:</div>
                                            <ul>{{ ordenDeTrabajo.astilleroCotizacion.cliente.correo }}</ul>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <div class="letra-azul">Embarcación:</div>
                                            <ul>{{ ordenDeTrabajo.astilleroCotizacion.barco.nombre }}</ul>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <div class="letra-azul">Modelo:</div>
                                            <ul>{{ ordenDeTrabajo.astilleroCotizacion.barco.modelo }}</ul>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <div class="letra-azul">Calado:</div>
                                            <ul>{{ ordenDeTrabajo.astilleroCotizacion.barco.calado }}</ul>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <div class="letra-azul">Manga:</div>
                                            <ul>{{ ordenDeTrabajo.astilleroCotizacion.barco.manga }}</ul>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <div class="letra-azul">Eslora:</div>
                                            <ul>{{ ordenDeTrabajo.astilleroCotizacion.barco.eslora }}</ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-8">
                                    <small class="pull-left">Precios en USD</small>
                                    <small class="pull-right">Tipo de cambio: <span
                                                id="precio-dolar">{{ (ordenDeTrabajo.astilleroCotizacion.dolar/100)| number_format(2) }}</span>
                                        MXN
                                    </small>
                                    <table class="table">
                                        <thead>
                                        <tr>
                                            <th>Cantidad</th>
                                            <th>Producto / Servicio</th>
                                            <th>Prec. Unid.</th>
                                            <th>Sub-Total</th>
                                            <th>IVA</th>
                                            <th>Total</th>
                                        </tr>
                                        </thead>
                                        <tbody id="servicios-cotizacion">
                                        {% for Aservicio in ordenDeTrabajo.astilleroCotizacion.acservicios %}
                                            {% if Aservicio.estatus %}
                                                <tr>
                                                    <td>{{ Aservicio.cantidad }}</td>
                                                    <td>
                                                        {% if Aservicio.servicio is not null %}
                                                            {{ Aservicio.servicio.nombre }}
                                                        {% elseif Aservicio.producto is not null %}
                                                            {{ Aservicio.producto.nombre }}
                                                        {% elseif Aservicio.otroservicio is not null %}
                                                            {{ Aservicio.otroservicio }}
                                                        {% elseif Aservicio.astilleroserviciobasico is not null %}
                                                            {{ Aservicio.astilleroserviciobasico.nombre }}
                                                        {% endif %}
                                                    </td>
                                                    <td>${{ (Aservicio.precio/100)|number_format(2) }}</td>
                                                    <td>${{ (Aservicio.subtotal/100)|number_format(2) }}</td>
                                                    <td>${{ (Aservicio.iva/100)|number_format(2) }}</td>
                                                    <td>${{ (Aservicio.total/100)|number_format(2) }}</td>
                                                </tr>
                                            {% endif %}
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                    <small>Iva: <span
                                                id="porcentaje-iva">{{ ordenDeTrabajo.astilleroCotizacion.iva | number_format(2) }}</span>%
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div role="tabpanel" class="tab-pane" id="contratistas">
                            <div class="row">
                                <div class="col-sm-12">
                                    <small class="pull-left">Precios en MXN</small>
                                    <small class="pull-right">Tipo de cambio:
                                        <span>{{ (ordenDeTrabajo.astilleroCotizacion.dolar/100)| number_format(2) }}</span>
                                        MXN
                                    </small>
                                    <table class="table">
                                        <thead>
                                        <tr>
                                            <th>Descripción del trabajo</th>
                                            <th>Contratista</th>
                                            <th>Razón social</th>
                                            <th>Precio contratista</th>
                                            <th>% V&V</th>
                                            <th>Utilidad V&V</th>
                                            <th>Precio V&V</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        {% for contratista in ordenDeTrabajo.contratistas %}
                                            <tr>
                                                <td>{{ contratista.cotizacionInicial }}</td>
                                                <td>{{ contratista.proveedor.nombre }}</td>
                                                <td>{{ contratista.proveedor.razonsocial }}</td>
                                                <td>${{ (contratista.precio/100)|number_format(2) }}</td>
                                                <td>{{ contratista.porcentajevv|number_format(2) }}%</td>
                                                <td>${{ (contratista.utilidadvv/100)|number_format(2) }}</td>
                                                <td>${{ (contratista.preciovv/100)|number_format(2) }}</td>
                                            </tr>
                                        {% endfor %}
                                        </tbody>
                                        <tfoot>
                                        <tr>
                                            <td colspan="3" rowspan="2" class="text-right">Totales:</td>
                                            <td>${{ (ordenDeTrabajo.precioTotal/100)|number_format(2) }}</td>
                                            <td></td>
                                            <td>${{ (ordenDeTrabajo.utilidadvvTotal/100)|number_format(2) }}</td>
                                            <td>${{ (ordenDeTrabajo.preciovvTotal/100)|number_format(2) }}</td>
                                        </tr>
                                        <tr>
                                            <td>
                                                ${{ ((ordenDeTrabajo.precioTotal/ordenDeTrabajo.astilleroCotizacion.dolar))|number_format(2) }}
                                                USD
                                            </td>
                                            <td></td>
                                            <td>
                                                ${{ ((ordenDeTrabajo.utilidadvvTotal/ordenDeTrabajo.astilleroCotizacion.dolar))|number_format(2) }}
                                                USD
                                            </td>
                                            <td>
                                                ${{ ((ordenDeTrabajo.preciovvTotal/ordenDeTrabajo.astilleroCotizacion.dolar))|number_format(2) }}
                                                USD
                                            </td>
                                        </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div role="tabpanel" class="tab-pane" id="flujograma">
                            <div class="row">
                                <div class="col-sm-12 table-responsive">
                                    <div style="position:relative; " class="gantt" id="GanttChartDIV" ></div>
                                </div>
                            </div>
                            <div class="row espacio-linea-arriba2">
                                <div class="col-sm-4">
                                    <label>Fecha incio</label>
                                    <div class="info-input">{{ ordenDeTrabajo.astilleroCotizacion.fechaLlegada|date('d/m/Y') }}</div>
                                </div>
                                <div class="col-sm-4">
                                    <label>Fecha fin</label>
                                    <div class="info-input">{{ ordenDeTrabajo.astilleroCotizacion.fechaSalida|date('d/m/Y') }}</div>
                                </div>
                            </div>
                            <div class="row espacio-linea-arriba2">
                                <div class="col-sm-12">
                                    <table class="table">
                                        <thead>
                                        <tr>
                                            <th></th>
                                            <th>Actividad</th>
                                            <th>Inicio</th>
                                            <th>Fin</th>
                                            <th>Detalles, avances, demoras y observaciones</th>
                                            <th>Responsable</th>
                                            <th>Ejecutor</th>
                                            <th>Porcentaje</th>
                                            <th>Estatus</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        {% for contratista in ordenDeTrabajo.contratistas %}
                                            <tr class="fondo-morado-2">
                                                <td colspan="9">
                                                    {{ contratista.cotizacionInicial }}
                                                    {% if is_granted(expression('has_role("ROLE_ODT_ACTIVIDAD") or (user.isAdmin())')) %}
                                                    <a class="btn btn-azul pull-right loadpage"
                                                       href="{{ path('ordendetrabajo_contratista_actividad', { 'id': contratista.id }) }}">
                                                        <i class="fa fa-plus" aria-hidden="true"></i>
                                                        Agregar
                                                    </a>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% for actividad in contratista.contratistaactividades %}
                                                {% if not actividad.isActividadPausa %}
                                                <tr class="{% if actividad.isPausado %}fondo-gris{% else %}fondo-morado-claro{% endif %}">
                                                    <td>
                                                        {#<a class="btn btn-warning letra-negra"#}
                                                           {#href="{{ path('ordendetrabajo_contratista_pausa-actividad', { 'id': actividad.id }) }}">#}
                                                            {#<i class="fa fa-play" aria-hidden="true"></i>#}
                                                            {#<i class="fa fa-pause" aria-hidden="true"></i>#}
                                                        {#</a>#}
                                                    </td>
                                                    <td>{{ actividad.nombre }}</td>
                                                    <td>{{ actividad.inicio|date('d/m/Y') }}</td>
                                                    <td>{{ actividad.fin|date('d/m/Y') }}</td>
                                                    <td>{{ actividad.notas }}</td>
                                                    <td>{{ actividad.responsable }}</td>
                                                    <td>{{ contratista.proveedor.nombre }}</td>
                                                    <td>{{ actividad.porcentaje|number_format(2) }}%</td>
                                                    <td class="estatus">
                                                        {% if actividad.isPausado %}
                                                            Pausado
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endif %}
                                            {% endfor %}
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                        </div>
                        {% if is_granted(expression('has_role("ROLE_ODT_CONTRATISTA_EDIT") or (user.isAdmin())')) %}
                        <div class="row espacio-linea-arriba2">
                            <div class="col-sm-12">
                                <a class="btn btn-azul"
                                   href="{{ path('ordendetrabajo_edit',{'id': ordenDeTrabajo.id}) }}">
                                    <i class="fa fa-pencil-square-o" aria-hidden="true"></i>
                                    Editar contratistas
                                </a>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </section>
    </div>
{% endblock %}
{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment.min.js') }}"></script>
    <script src="{{ asset('bower_components/jquery-slimscroll/jquery.slimscroll.min.js') }}"></script>
    <script src="{{ asset('https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.9.0/fullcalendar.min.js') }}"></script>
    <script src="{{ asset('https://cdnjs.cloudflare.com/ajax/libs/fullcalendar-scheduler/1.9.4/scheduler.min.js') }}"></script>
    <script src="{{ asset('bower_components/fullcalendar/dist/locale/es.js') }}"></script>
    <script src="{{ asset('js/jsgantt.js') }}"></script>
    <script type="text/javascript">
        var g = new JSGantt.GanttChart(document.getElementById('GanttChartDIV'), 'day' );
        g.addLang('espanol', {
            'january': 'Enero',
            'february': 'Febrero',
            'march': 'Marzo',
            'april': 'Abril',
            'maylong': 'Mayo',
            'june': 'Junio',
            'july': 'Julio',
            'august': 'Agosto',
            'september': 'Septiembre',
            'october': 'Octubre',
            'november': 'Noviembre',
            'december': 'Deciembre',
            'jan': 'Ene',
            'feb': 'Feb',
            'mar': 'Mar',
            'apr': 'Abr',
            'may': 'May',
            'jun': 'Jun',
            'jul': 'Jul',
            'aug': 'Ago',
            'sep': 'Sep',
            'oct': 'Oct',
            'nov': 'Nov',
            'dec': 'Dic',
            'sunday': 'Domingo',
            'monday': 'Lunes',
            'tuesday': 'Martes',
            'wednesday': 'Miércoles',
            'thursday': 'Jueves',
            'friday': 'Viernes',
            'saturday': 'Sábado',
            'sun': 'Dom',
            'mon': 'Lun',
            'tue': 'Mar',
            'wed': 'Mie',
            'thu': 'Jue',
            'fri': 'Vie',
            'sat': 'Sab',
            'resource': 'Responsable',
            'duration': 'Duración',
            'comp': '% Comp.',
            'completion': 'Terminación',
            'startdate': 'Inicia',
            'enddate': 'Termina',
            'moreinfo': 'Más información',
            'notes': 'Notas',
            'format': 'Formato',
            'hour': 'Hora',
            'day': 'Día',
            'week': 'Semana',
            'month': 'Mes',
            'quarter': 'Trimestre',
            'hours': 'Horas',
            'days': 'Días',
            'weeks': 'Semanas',
            'months': 'Meses',
            'quarters': 'Trimestres',
            'hr': 'Hr',
            'dy': 'D',
            'wk': 'S',
            'mth': 'M',
            'qtr': 'Tri',
            'hrs': 'Hrs',
            'dys': 'Dias',
            'wks': 'Sems',
            'mths': 'Ms',
            'qtrs': 'Tris'
        });
        if( g.getDivId() != null ) {
            g.setCaptionType('Complete');  // Set to Show Caption (None,Caption,Resource,Duration,Complete)
            g.setQuarterColWidth(36);
            g.setRowHeight(30);
            g.setDayColWidth(45);
            g.setWeekColWidth(60);
            g.setMonthColWidth(60);
            g.setDateTaskDisplayFormat('day dd month yyyy'); // Shown in tool tip box
            g.setDayMajorDateDisplayFormat('mon yyyy - Week ww') // Set format to display dates in the "Major" header of the "Day" view
            g.setWeekMinorDateDisplayFormat('dd mon') // Set format to display dates in the "Minor" header of the "Week" view
            g.setShowTaskInfoLink(0); //Show link in tool tip (0/1)
            g.setShowEndWeekDate(0); // Show/Hide the date for the last day of the week in header for daily view (1/0)
            g.setUseSingleCell(10000); // Set the threshold at which we will only use one cell per table row (0 disables).  Helps with rendering performance for large charts.
            g.setFormatArr('Day'); // Even with setUseSingleCell using Hour format on such a large chart can cause issues in some browsers
            g.setLang('espanol');
            g.setShowRes(0);
            g.setShowDur(1);
            g.setShowStartDate(0);
            g.setShowEndDate(0);
            g.setShowTaskInfoNotes(0);
            // Parameters                     (pID, pName,                  pStart,       pEnd,        pStyle,         pLink (unused)  pMile, pRes,       pComp, pGroup, pParent, pOpen, pDepend, pCaption, pNotes, pGantt)
            {% set x = 1 %}
            {% set y = 1 %}
            {% for contratista in ordenDeTrabajo.contratistas %}
                g.AddTaskItem(new JSGantt.TaskItem({{ x }},
                    '{{ contratista.cotizacionInicial }}',
                    '',
                    '',
                    'ggroupblack',
                    'link',
                    0,
                    'Responsable',
                    0,1,0,1,'','',
                    '',
                    g));
                {% for actividad in contratista.contratistaactividades %}
            {% if not actividad.isActividadPausa %}
                    g.AddTaskItem(new JSGantt.TaskItem({{ x~y }},
                        '{{ actividad.nombre }}',
                        '{{ actividad.inicio|date('Y-m-d') }}',
                        '{{ actividad.fin|date('Y-m-d') }}',
                        'gtaskgreen',
                        '',
                        0,
                        '{{ actividad.responsable }}',{{ actividad.porcentaje }},
                        0,{{ x }},
                        1, '', '', '{{ actividad.notas }}', g));
                    {% set y = y+1 %}
            {% endif %}
                {% endfor %}
                {% set x = x+1 %}
                {% set y = 1 %}
            {% endfor %}
            g.Draw();
        } else {
            alert("Error, unable to create Gantt Chart");
        }

        // $('.pausar-actividad').on('click',function () {
        //     var filaApausar = $(this).parent().parent();
        //     var idactividad = this.dataset.id;
        //     var url = `${location.protocol + '//' + location.host}/novonautica/web/app_dev.php/astillero/odt/${idactividad}/pausar`;
        //     $.ajax({
        //         method: "GET",
        //         url: url,
        //         success: function(pausado) {
        //             console.log(pausado);
        //             if(pausado === 'true'){
        //                 console.log('es verdad');
        //                 filaApausar.removeClass('fondo-morado-claro').addClass('fondo-gris');
        //                 filaApausar.children('.estatus').html('Pausado');
        //             }else{
        //                 console.log('es falso');
        //                 filaApausar.removeClass('fondo-gris').addClass('fondo-morado-claro');
        //                 filaApausar.children('.estatus').html('');
        //             }
        //         }
        //     });
        // });
    </script>
{% endblock %}