<?php

namespace AppBundle\Repository;

use Doctrine\ORM\NonUniqueResultException;
use Doctrine\ORM\NoResultException;

/**
 * SlipMovimientoRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class SlipMovimientoRepository extends \Doctrine\ORM\EntityRepository
{
    /**
     * @param $slip
     * @param $start
     * @param $end
     *
     * @return mixed
     * @throws NonUniqueResultException
     */
    public function isSlipOpen($slip, $start, $end)
    {
        return $this->createQueryBuilder('sm')
            ->where('
                    sm.slip = :slip AND
                    ((:fechaLlegada BETWEEN sm.fechaLlegada AND sm.fechaSalida) OR
                     (:fechaSalida BETWEEN sm.fechaLlegada AND sm.fechaSalida))
                ')
            ->setParameters([
                'slip' => $slip,
                'fechaLlegada' => $start,
                'fechaSalida' => $end,
            ])
            ->setMaxResults(1)
            ->getQuery()
            ->getOneOrNullResult();
    }

    public function getSlipInformation($slip, $cotizacion)
    {
        return $this->createQueryBuilder('sm')
            ->select('sm', 'slip', 'cotizacion', 'cliente', 'barco')
            ->where('sm.slip = :slip AND sm.marinahumedacotizacion = :cotizacion')
            ->leftJoin('sm.slip', 'slip')
            ->leftJoin('sm.marinahumedacotizacion', 'cotizacion')
            ->leftJoin('cotizacion.cliente', 'cliente')
            ->leftJoin('cotizacion.barco', 'barco')
            ->setParameters([
                'slip' => $slip,
                'cotizacion' => $cotizacion
            ])
            ->getQuery()
            ->getResult();
    }

    public function getCurrentOcupation($fecha)
    {
        return $this->createQueryBuilder('sm')
            ->select('sm', 'slip', 'cotizacion', 'cliente', 'barco')
            ->leftJoin('sm.slip', 'slip')
            ->leftJoin('sm.marinahumedacotizacion', 'cotizacion')
            ->leftJoin('cotizacion.cliente', 'cliente')
            ->leftJoin('cotizacion.barco', 'barco')
            ->where(':fecha BETWEEN sm.fechaLlegada AND sm.fechaSalida')
            ->setParameter('fecha', $fecha)
            ->getQuery()
            ->getResult();
    }

    public function getCurrentOcupationStats($fecha)
    {
        $slipRepository = $this->getEntityManager()->getRepository('AppBundle:Slip');

        $subquery = $slipRepository->createQueryBuilder('ss')
            ->select('COUNT(ss.id)')
            ->where('ss.pies = s.pies');

        return $this->createQueryBuilder('sm')
            ->select('s.pies',
                'COUNT(sm.id) AS ocupados',
                "({$subquery->getDQL()}) AS total")
            ->leftJoin('sm.slip', 's')
            ->where(':fecha BETWEEN sm.fechaLlegada AND sm.fechaSalida')
            ->groupBy('s.pies')
            ->orderBy('s.pies', 'ASC')
            ->setParameter('fecha', $fecha)
            ->getQuery()
            ->getScalarResult();
    }

    public function getTimelineEvents($start, $end)
    {
        return $this->createQueryBuilder('sm')
            ->select(
                'sm.id AS id',
                'IDENTITY(sm.slip) AS resourceId',
                'sm.fechaLlegada AS start',
                'sm.fechaSalida AS end',
                'CASE WHEN sm.nota IS NOT NULL THEN sm.nota ELSE b.nombre END AS title',
                'CASE WHEN sm.nota IS NOT NULL THEN \'#f3b41b\' ELSE \'#db245d\' END AS backgroundColor',
                'CASE WHEN sm.nota IS NOT NULL THEN \'#000\' ELSE \'#fff\' END AS textColor'
            )
            ->leftJoin('sm.marinahumedacotizacion', 'mhc')
            ->leftJoin('mhc.barco', 'b')
            ->where('((sm.fechaLlegada BETWEEN :start AND :end) 
                OR (sm.fechaSalida BETWEEN :start AND :end))')
            ->orderBy('sm.slip')
            ->setParameters([
                'start' => $start->format('Y-m-d'),
                'end' => $end->format('Y-m-d')
            ])
            ->getQuery()
            ->getResult();
    }

    public function getOcupationRateByDaterange(\DateTime $start, \DateTime $end)
    {
        return $this->createQueryBuilder('sm')
            ->select(
                'IDENTITY(sm.slip) AS slip',
                'cliente.nombre AS nombreCliente',
                'barco.nombre AS nombreEmbarcacion',
                'sm.fechaLlegada AS llegada',
                'sm.fechaSalida AS salida',
                '(CASE WHEN DATE_DIFF(sm.fechaSalida, sm.fechaLlegada) = 0 ' .
                'THEN 1 ELSE DATE_DIFF(sm.fechaSalida, sm.fechaLlegada) END) AS diasOcupados',
                'DATE_DIFF(:end, :start) AS diasTotal',
                '(CASE WHEN DATE_DIFF(sm.fechaSalida, sm.fechaLlegada) = 0' .
                'THEN (1 / DATE_DIFF(:end, :start))' .
                'ELSE (DATE_DIFF(sm.fechaSalida, sm.fechaLlegada) * 100) / DATE_DIFF(:end, :start) END) ' .
                'AS porcentajeOcupacion'
            )
            ->leftJoin('sm.marinahumedacotizacion', 'cotizacion')
            ->leftJoin('cotizacion.barco', 'barco')
            ->leftJoin('cotizacion.cliente', 'cliente')
            ->where('sm.fechaLlegada >= :start AND sm.fechaSalida <= :end AND sm.nota IS NULL')
            ->setParameters([
                'start' => $start,
                'end' => $end
            ])
            ->orderBy('sm.slip')
            ->getQuery()
            ->getArrayResult();
    }
}
