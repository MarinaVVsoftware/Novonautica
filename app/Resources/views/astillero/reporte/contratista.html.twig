{% extends 'estructura/plantilla.twig' %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/daterangepicker.css') }}">
    <style>
        :root .btn {
            min-width: initial;
            text-align: center;
        }

        :root .panel-body form.form-inline input {
            width: 250px;
        }

        .daterangepicker {
            color: initial;
            font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif;
            background-color: #292f41;
            border-color: #2a3041;
        }

        .ranges li {
            background-color: hsl(225, 23%, 21%);
            border: 1px solid #292f41;
        }

        .form-inline {
            margin-bottom: 2rem;
        }

        .autocomplete-suggestions {
            background: #3e4766;
            overflow: auto;
            width: auto !important;
            min-width: 100px;
        }

        .autocomplete-suggestion {
            padding: 2px 5px;
            white-space: nowrap;
            overflow: hidden;

        }

        .autocomplete-selected {
            background: #0097f6;
        }

        .autocomplete-suggestions strong {
            font-weight: normal;
            color: #3399FF;
        }

        .autocomplete-suggestion:hover strong {
            color: #363c52;
        }

        .autocomplete-group {
            padding: 2px 5px;
        }

        .autocomplete-group strong {
            display: block;
            border-bottom: 1px solid #000;
        }

        .form-inline .form-group {
            margin-right: 1rem;
        }
    </style>
{% endblock %}

{% block contwrapper %}
    <div class="content-wrapper">
        <section class="content">
            <div class="panel panel-novo">
                <div class="panel-heading">
                    <h3 class="panel-title">Reportes de contratistas</h3>
                </div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-sm-12">
                            <form id="reporte-data" class="form-inline"
                                  action="{{ path('reporte_ast_contratista_data') }}">
                                <div class="form-group">
                                    <label for="date-range">Rango</label>
                                    <input type="text" class="form-control" id="date-range" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="contratista">Contratista</label>
                                    <input type="text" class="form-control" id="contratista" required>
                                </div>
                                <input type="submit" value="Consultar" id="consultar" class="btn btn-azul" disabled>
                            </form>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-12">
                            <form style="margin-top: 4rem;">
                                <div class="col-sm-4">
                                    <div class="form-group">
                                        <label for="adeudo">Adeudo</label>
                                        <div class="input-group">
                                            <span class="input-group-addon">$</span>
                                            <input type="text" class="form-control" id="adeudo" disabled>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-4">
                                    <div class="form-group">
                                        <label for="pagado">Pagado</label>
                                        <div class="input-group">
                                            <span class="input-group-addon">$</span>
                                            <input type="text" class="form-control" id="pagado" disabled>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-4">
                                    <div class="form-group">
                                        <label for="total">Total</label>
                                        <div class="input-group">
                                            <span class="input-group-addon">$</span>
                                            <input type="text" class="form-control" id="total" disabled>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-12">
                            <table class="table table-novo">
                                <thead>
                                <tr>
                                    <th width="30%">Descripcion</th>
                                    <th width="15%">Embarcación</th>
                                    <th width="15%">Adeudo</th>
                                    <th width="15%">Pagado</th>
                                    <th width="20%">Fecha</th>
                                </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript" src="{{ asset('bower_components/moment/min/moment.min.js') }}"></script>
    <script type="text/javascript" src="{{ asset('bower_components/moment/locale/es.js') }}"></script>
    <script type="text/javascript" src="{{ asset('js/daterangepicker.js') }}"></script>
    <script type="text/javascript" src="{{ asset('js/jquery.autocomplete.min.js') }}"></script>
    <script type="text/javascript">
      (function ($) {
        moment.locale('es');

        const rTabla = document.querySelector('.table > tbody');
        const rForm = document.getElementById('reporte-data');
        const submitBtn = document.getElementById('consultar');
        const adeudoInput = document.getElementById('adeudo');
        const pagadoInput = document.getElementById('pagado');
        const totalInput = document.getElementById('total');

        const $contratista = $('#contratista');
        const $dateRange = $('#date-range');

        const inicio = moment().subtract(29, 'days');
        const final = moment();

        let searchData = {
          start: inicio.format('YYYY-MM-DD'),
          end: final.format('YYYY-MM-DD')
        };

        if (searchData.proveedor) {
          submitBtn.removeAttribute('disabled');
        }

        $contratista.autocomplete({
          dataType: 'json',
          deferRequestBy: 300,
          showNoSuggestionNotice: true,
          noSuggestionNotice: 'No se encontraron resultados',
          triggerSelectOnValidInput: false,
          minChars: 2,
          serviceUrl: 'proveedores.json',
          transformResult: function (proveedores) {
            return {
              suggestions: proveedores.map(proveedor => {
                return {
                  value: proveedor.nombre,
                  data: proveedor.id
                }
              })
            }
          },
          onSelect: function ({data}) {
            searchData.proveedor = data;
            submitBtn.removeAttribute('disabled');
          }
        });

        $dateRange.daterangepicker({
          startDate: inicio,
          endDate: final,
          autoApply: true,
          ranges: {
            'Hoy': [moment(), moment()],
            'Ayer': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
            'Últimos 7 días': [moment().subtract(6, 'days'), moment()],
            'Últimos 30 días': [moment().subtract(29, 'days'), moment()],
            'Este mes': [moment().startOf('month'), moment().endOf('month')],
            'Mes pasado': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
          },
          locale: {
            applyLabel: 'Aplicar',
            cancelLabel: 'Cancelar',
            fromLabel: 'Desde',
            toLabel: 'Hasta',
            customRangeLabel: 'Definido por usuario',
          }
        });

        $dateRange.on('apply.daterangepicker', function (e, picker) {
          searchData.start = picker.startDate.format('YYYY-MM-DD');
          searchData.end = picker.endDate.format('YYYY-MM-DD');
        });

        rForm.addEventListener('submit', function (e) {
          e.preventDefault();
          $.ajax(this.action, {dataType: 'json', data: searchData})
              .done(function (trabajos) {
                clearData();


                if (!trabajos.length) {
                  rTabla.innerHTML = `
                    <tr><td colspan="4" class="text-center">No existen registros en la fecha seleccionada</td></tr>
                  `;

                  return;
                }

                let adeudo = trabajos.reduce((a, b) => a + b.total, 0);
                let pagado = trabajos.map(function (trabajo) {
                  let dolarCambio = (trabajo.astilleroODT.astilleroCotizacion.dolar / 100);
                  let pagos = trabajo.contratistapagos.reduce((a, b) => b.divisa === 'USD' ? a + (b.cantidad * dolarCambio) : a + b.cantidad, 0);
                  let row = rTabla.insertRow();

                  row.insertCell().innerText = trabajo.cotizacionInicial;
                  row.insertCell().innerText = trabajo.astilleroODT.astilleroCotizacion.barco.nombre;
                  row.insertCell().innerText = '$' + (trabajo.total / 100).toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, '$1,') + 'MXN';
                  row.insertCell().innerText = '$' + (pagos / 100).toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, '$1,') + 'MXN';
                  row.insertCell().innerText = trabajo.astilleroODT.fecha;

                  return pagos;
                })[0];
                let total = (adeudo - pagado);

                adeudoInput.value = (adeudo / 100).toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, '$1,') + 'MXN';
                pagadoInput.value = (pagado / 100).toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, '$1,') + 'MXN';
                totalInput.value = (total / 100).toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, '$1,') + 'MXN';

              });
        });


        function clearData() {
          rTabla.innerHTML = '';
          adeudoInput.value = '';
          pagadoInput.value = '';
          totalInput.value = '';
        }

      })(jQuery);
    </script>
{% endblock %}